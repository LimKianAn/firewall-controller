table ip firewall {
	# trusted networks specify networks where direct access to the firewall is allowed drom
	set trusted_networks {
		type ipv4_addr
		flags interval
		auto-merge
		elements = { 0.0.0.0/0 }
	}

	# internal prefixes, which are not leaving the partition or the partition interconnect
	set internal_prefixes {
		type ipv4_addr
		flags interval
		auto-merge
		
		elements = { 1.2.3.0/24, 2.3.4.0/8 }
		
	}

	# Prefixes in the cluster, typically 10.x.x.x
	# FIXME Should be filled with nodeCidr
	set cluster_prefixes {
		type ipv4_addr
		flags interval
		auto-merge
		elements = { 10.0.0.0/8 }
	}

	# counters
	counter internal_total { }
	counter external_in { }
	counter external_out { }
	counter drop_total { }
	counter drop_ratelimit { }
	counter ssh_from_trusted_networks { }
	counter ssh_from_untrusted_networks { }

	chain input {
		type filter hook input priority -1; policy accept;
		ip saddr == @trusted_networks tcp dport ssh ct state new counter name ssh_from_trusted_networks accept comment "SSH incoming connections from trusted networks"
		tcp dport ssh ct state new counter name ssh_from_untrusted_networks drop comment "blocked SSH incoming connections from untrusted networks"
	}

	chain forward {
		type filter hook forward priority 1; policy drop;

		# network traffic accounting for external traffic
		ip saddr != @internal_prefixes counter name external_in
		ip daddr != @internal_prefixes counter name external_out

		# network traffic accounting for internal traffic
		ip saddr == @internal_prefixes ip daddr == @internal_prefixes counter name internal_total

		# rate limits
		meta iifname "eth0" limit rate over 10 mbytes/second counter name drop_ratelimit drop

		# state dependent rules
		ct state established,related counter accept comment "accept established connections"
		ct state invalid counter drop comment "drop packets with invalid ct state"

		# icmp
		ip protocol icmp icmp type echo-request limit rate over 10/second burst 4 packets counter drop comment "drop ping floods"
		ip protocol icmp icmp type { destination-unreachable, router-solicitation, router-advertisement, time-exceeded, parameter-problem } counter accept comment "accept icmp"

		# dynamic ingress rules
		ingress rule 1
		ingress rule 2

		# dynamic egress rules
		egress rule 1
		egress rule 2

		counter comment "count and log dropped packets"
		limit rate 10/second counter name drop_total log prefix "nftables-firewall-dropped: "
	}
}
